{% extends "header.html" %} {% load bootstrap3 %}
{% block content %}
<br>
<br>
<br> 
<br>
<br>
<body>
<form method="POST" action=''>{% csrf_token show_label=False %}
<div class="panel panel-default">
    <div class="panel-body" id="body-container">
        <div id="left_side_fields">
            <input type="submit" id="delete" class="btn btn-default" name="delete" value="" title="eliminar"/>
            <input type="submit" id="reload" class="btn btn-default"
            name="reload" value="" title="recargar"/>
            <input type="submit" id="guardar" class="btn btn-default" name="guardar" value="" title="guardar"/>
            <br/>
            <br/>
            <br/>
            <label>Título</label> 
            {% bootstrap_field form.title show_label=False %}
            <label>Descripción</label> 
            {% bootstrap_field form.description show_label=False %}
            <label>Disponibilidad</label> 
            {% bootstrap_field form.public show_label=False %}
            <label>Tags</label> 
            {% bootstrap_field form.tags show_label=False %}
        </div>
        <div id="rich_text">
                {% bootstrap_field form.summernote show_label=False %}
        </div>
        <div id="side_fields">
            <input type="button" id="gendoc" class="btn btn-default" title="actualizar campos" onclick="change();"/> 
            <br/>
            <span id="placeholder">&nbsp;</span>
        </div>
    </div>
</div>
</body>

<a href="#myModal" id="modalbtn" role="button" class="btn btn-large btn-primary" data-toggle="modal"></a>
<!-- Modal HTML -->
<div id="myModal" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body">
                <input type="submit" id="genpdf" class="btn btn-default" name="genpdf" value="PDF" title="pdf"/>
                <input type="submit" id="genword" class="btn btn-default" name="genword" value="DOCX" title="docx"/>
            </div>
        </div>
    </div>
</div>
</form>

<script language="javascript">

var modalbtn = function (context) {
  var ui = $.summernote.ui;
  // create button
  var button = ui.button({
    contents: '<i class="fa fa-child"/>Export',
    tooltip: 'Export',
    click: function () {
        $('#modalbtn').click();
    }
  });
  return button.render();
}

$('#id_summernote').summernote({
    toolbar: [
        ['style', ['style']],
        ['style', ['bold', 'italic', 'underline', 'strikethrough']],
        ['fontsize', ['fontsize']],
        ['color', ['color']],
        ['para', ['ul', 'ol', 'paragraph']],
        ['insert', ['picture']],
        ['table', ['table']],
        ['mybutton', ['modalbtn']],
        ['view', ['codeview']],
      ],

      buttons: {
          modalbtn: modalbtn,
        },
      height: 600,

});
$('#id_summernote').summernote('code');


function change(){

    var texto = $('#id_summernote').summernote('code');
    var words = texto.match(/\[\w+\]/gi);

    for(var i=0; i < words.length; i++) {
        words[i] = words[i].replace(/\[|\]/g, '');
    }
    var unique_words = words.filter(function(elem, pos) {
        return words.indexOf(elem) == pos;
      }); 

    var fields = document.getElementsByClassName('field form-control');
    replace_words  = [].map.call(fields, function(input) {
        return input.value;
    })
     
    var mapObj = {}
    $.each(replace_words,function(i,val){
        mapObj[unique_words[i]] = val;
    });
    //alert (JSON.stringify(mapObj))

    var re = new RegExp(Object.keys(mapObj).join("|"),"g");
    texto = texto.replace(re, function(matched){
        return mapObj[matched];
    })
    $('#id_summernote').summernote('code', texto);
    $('#id_summernote-textarea').html(texto);
}

function add() {
    placeholder = $("#placeholder");
    placeholder.empty();
    texto = $('#id_summernote').summernote('code');
    var fields = texto.match(/\[(\w+)\]/g);
    texto = texto.replace(/\[/g, "<span class='hl'>[_").replace(/\]/g, "_]</span>");
    $('#id_summernote').summernote('code', texto);

    var unique_fields = fields.filter(function(elem, pos) {
        return fields.indexOf(elem) == pos;
      }); 
    var uniquelength = unique_fields.length;

    for (var i = 0; i < uniquelength; i++) {

        var element = document.createElement("input");
        var elementlabel = document.createElement("span");
        
        element.setAttribute("type", "input");
        element.setAttribute("class", "field form-control");
        elementlabel.setAttribute("class", "field_label");
        //element.setAttribute("required", false);
        element.setAttribute("name", unique_fields[i]);
        elementlabel.innerHTML = unique_fields[i];
                                                        
        //x = $.inArray(element, placeholder);

        if ($('input[name="' + unique_fields + '"]').length <= 0) {
           placeholder.append(elementlabel);
           placeholder.append(element);
        }
    }
}
$(document).ready(add);

</script>
{% endblock %}
